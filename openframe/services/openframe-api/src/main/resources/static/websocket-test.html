<!DOCTYPE html>
<html>
<head>
    <title>OpenFrame Test Client</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        .container { margin: 20px; }
        .log { 
            background: #f4f4f4; 
            padding: 10px; 
            height: 300px; 
            overflow-y: scroll; 
        }
        .connected { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h2>OpenFrame Test Client</h2>
        
        <!-- Authentication -->
        <div>
            <h3>Authentication</h3>
            <input type="text" id="clientId" placeholder="Client ID" value="test_client">
            <input type="text" id="clientSecret" placeholder="Client Secret" value="test_secret">
            <button onclick="authenticate()">Get Token</button>
        </div>

        <!-- WebSocket -->
        <div>
            <h3>WebSocket</h3>
            <button onclick="connectWebSocket()" id="wsConnect" disabled>Connect WebSocket</button>
            <button onclick="disconnect()" id="wsDisconnect" disabled>Disconnect</button>
        </div>

        <!-- Test Messages -->
        <div>
            <h3>Send Test Message</h3>
            <button onclick="sendTestMetrics()" id="sendMetrics" disabled>Send Metrics</button>
        </div>

        <!-- Log -->
        <div>
            <h3>Log</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        let stompClient = null;
        let accessToken = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function authenticate() {
            const clientId = document.getElementById('clientId').value;
            const clientSecret = document.getElementById('clientSecret').value;

            try {
                const response = await fetch('http://localhost:8090/oauth/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'grant_type': 'client_credentials',
                        'client_id': clientId,
                        'client_secret': clientSecret
                    })
                });

                const data = await response.json();
                accessToken = data.access_token;
                log(`Authentication successful: ${accessToken}`);
                document.getElementById('wsConnect').disabled = false;
            } catch (error) {
                log(`Authentication error: ${error}`, 'error');
            }
        }

        function connectWebSocket() {
            if (!accessToken) {
                log('No access token available', 'error');
                return;
            }

            const socket = new SockJS('http://localhost:8090/ws/v1/data', null, {
                transportOptions: {
                    websocket: {
                        headers: {
                            'Authorization': 'Bearer ' + accessToken
                        }
                    }
                }
            });

            stompClient = Stomp.over(socket);
            
            const headers = {
                'Authorization': 'Bearer ' + accessToken
            };
            
            stompClient.connect(
                headers,
                frame => {
                    log('Connected to WebSocket', 'connected');
                    document.getElementById('wsConnect').disabled = true;
                    document.getElementById('wsDisconnect').disabled = false;
                    document.getElementById('sendMetrics').disabled = false;

                    // Subscribe to topics
                    stompClient.subscribe('/topic/alerts', message => {
                        log(`Received alert: ${message.body}`);
                    });

                    stompClient.subscribe('/queue/machine.test', message => {
                        log(`Received message: ${message.body}`);
                    });
                },
                error => {
                    log(`WebSocket error: ${error}`, 'error');
                    document.getElementById('wsConnect').disabled = false;
                    document.getElementById('wsDisconnect').disabled = true;
                    document.getElementById('sendMetrics').disabled = true;
                }
            );
        }

        function disconnect() {
            if (stompClient) {
                stompClient.disconnect();
                log('Disconnected from WebSocket');
                document.getElementById('wsConnect').disabled = false;
                document.getElementById('wsDisconnect').disabled = true;
                document.getElementById('sendMetrics').disabled = true;
            }
        }

        function sendTestMetrics() {
            if (stompClient) {
                const metrics = {
                    machineId: 'test_machine',
                    cpu: Math.round(Math.random() * 100),
                    memory: Math.round(Math.random() * 100),
                    timestamp: new Date().toISOString()
                };

                stompClient.send('/app/metrics', {}, JSON.stringify(metrics));
                log(`Sent metrics: ${JSON.stringify(metrics)}`);
            }
        }
    </script>
</body>
</html>