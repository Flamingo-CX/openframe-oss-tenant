apiVersion: batch/v1
kind: Job
metadata:
  name: meshcentral-mongodb
  annotations:
    "argocd.argoproj.io/hook": PostSync
    "argocd.argoproj.io/hook-delete-policy": HookSucceeded
spec:
  backoffLimit: 3
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: register
        image: curlimages/curl:8.5.0
        env:
        - name: MONGODB_HOST
          valueFrom:
            configMapKeyRef:
              name: meshcentral-mongodb
              key: MONGODB_HOST
        - name: MONGODB_PORT
          valueFrom:
            configMapKeyRef:
              name: meshcentral-mongodb
              key: MONGODB_PORT
        - name: MONGO_INITDB_ROOT_USERNAME
          valueFrom:
            secretKeyRef:
              name: meshcentral-mongodb
              key: MONGO_INITDB_ROOT_USERNAME
        - name: MONGO_INITDB_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: meshcentral-mongodb
              key: MONGO_INITDB_ROOT_PASSWORD
        command:
        - /bin/sh
        - -c
        - |
          echo "Registering MeshCentral MongoDB..."
          curl -X POST "http://openframe-management.microservices.svc.cluster.local:8095/v1/tools/meshcentral-mongodb" \
            -H "Content-Type: application/json" \
            -d "{
              \"tool\": {
                \"id\": \"meshcentral-mongodb\",
                \"toolType\": \"MONGODB\",
                \"name\": \"MeshCentral MongoDB\",
                \"description\": \"MongoDB Backend for MeshCentral\",
                \"toolUrls\": [
                  {
                    \"url\": \"mongodb://${MONGODB_HOST}\",
                    \"port\": \"${MONGODB_PORT}\",
                    \"type\": \"DATABASE\"
                  }
                ],
                \"category\": \"NoSQL Database\",
                \"platformCategory\": \"Integrated Tool\",
                \"enabled\": true,
                \"credentials\": {
                  \"username\": \"${MONGO_INITDB_ROOT_USERNAME}\",
                  \"password\": \"${MONGO_INITDB_ROOT_PASSWORD}\"
                },
                \"layer\": \"Integrated Tools\",
                \"layerOrder\": 6,
                \"layerColor\": \"#4CAF50\",
                \"metricsPath\": \"/metrics\",
                \"healthCheckEndpoint\": \"/\",
                \"healthCheckInterval\": 30,
                \"connectionTimeout\": 5000,
                \"readTimeout\": 5000,
                \"allowedEndpoints\": [\"/metrics\"],
                \"debeziumConnector\": null
              }
            }" \
            --retry 5 \
            --retry-delay 2 \
            --retry-all-errors \
            --silent --show-error
          echo "MeshCentral MongoDB Registration complete."
