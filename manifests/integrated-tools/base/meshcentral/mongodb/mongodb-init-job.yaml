apiVersion: batch/v1
kind: Job
metadata:
  name: mongodb-init
  namespace: integrated-tools
spec:
  backoffLimit: 4
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: mongo-init
        image: mongo:8.0.9
        envFrom:
          - secretRef:
              name: mongodb-secret
          - configMapRef:
              name: mongodb-config
        env:
        - name: MONGO_HOST
          value: "meshcentral-mongodb.integrated-tools.svc.cluster.local:27017"
        command:
        - /bin/bash
        - -ec
        - |
          echo "Waiting for MongoDB service to be ready..."
          until mongosh --host meshcentral-mongodb.integrated-tools.svc.cluster.local:27017 --eval "db.adminCommand('ping')" > /dev/null 2>&1; do
            echo "Waiting for MongoDB to be accessible..."
            sleep 5
          done

          echo "MongoDB service is accessible, waiting additional time for startup..."
          sleep 10

          echo "Checking replica set status..."
          RS_STATUS=$(mongosh --host "$MONGO_HOST" --eval '
            try {
              let status = rs.status();
              if (status && status.ok && status.members && status.members[0].stateStr === "PRIMARY") {
                print("initialized");
              } else {
                print("not_initialized");
              }
            } catch(e) {
              if(e.message.includes("not initialized") || e.message.includes("invalid") || e.message.includes("not a member")) {
                print("not_initialized");
              } else {
                print("error: " + e.message);
              }
            }
          ' --quiet)
          echo "Replica set status check result: $RS_STATUS"

          if [ "$RS_STATUS" = "not_initialized" ]; then
            echo "Initializing replica set..."
            mongosh --host "$MONGO_HOST" --eval '
              rs.initiate({
                _id: "rs0",
                members: [
                  { _id: 0, host: "meshcentral-mongodb.integrated-tools.svc.cluster.local:27017" }
                ]
              });
            ' --quiet
            
            echo "Waiting for replica set to stabilize..."
            sleep 10
            
            echo "Waiting for replica set to be ready..."
            for i in {1..30}; do
              STATUS=$(mongosh --host "$MONGO_HOST" --eval '
                try {
                  let status = rs.status();
                  if(status && status.ok && status.members && status.members[0].stateStr === "PRIMARY") {
                    print("ready");
                  } else {
                    print("not_ready");
                  }
                } catch(e) {
                  print("error: " + e.message);
                }
              ' --quiet)
              
              if [ "$STATUS" = "ready" ]; then
                echo "Replica set is ready!"
                break
              fi
              echo "Retry $i: Waiting for replica set to be ready (status: $STATUS)..."
              sleep 5
            done
          elif [ "$RS_STATUS" = "initialized" ]; then
            echo "Replica set is already initialized and healthy"
          else
            echo "Error checking replica set status: $RS_STATUS"
            exit 1
          fi

          echo "Checking admin user..."
          if ! mongosh --host "$MONGO_HOST" -u "$MONGO_INITDB_ROOT_USERNAME" -p "$MONGO_INITDB_ROOT_PASSWORD" --authenticationDatabase admin --eval "db.adminCommand('ping')" >/dev/null 2>&1; then
            echo "Creating admin user..."
            mongosh --host "$MONGO_HOST" --eval "
              db.getSiblingDB('admin').createUser({
                user: '$MONGO_INITDB_ROOT_USERNAME',
                pwd: '$MONGO_INITDB_ROOT_PASSWORD',
                roles: [
                  { role: 'root', db: 'admin' },
                  { role: 'userAdminAnyDatabase', db: 'admin' },
                  { role: 'dbAdminAnyDatabase', db: 'admin' },
                  { role: 'readWriteAnyDatabase', db: 'admin' }
                ]
              })
            "
          else
            echo "Admin user already exists"
          fi

          echo "Final replica set status:"
          mongosh --host "$MONGO_HOST" --eval "rs.status()" --quiet
