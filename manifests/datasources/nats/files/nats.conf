port: 4222

http: 8222

websocket {
  port: 8080
  no_tls: true
}

# Глобальная настройка JetStream (включает поддержку на сервере)
jetstream {
  store_dir: "/data/jetstream"
}

accounts: {
  # ------------------------
  # Системный аккаунт
  # ------------------------
  SYS: {
    users: [
      { user: "{{ .Values.credentials.admin_user }}", password: "{{ .Values.credentials.admin_pass }}" }
    ],
    exports: [
      # Экспортируем системный топик подключений DEVICES
      { stream: "$SYS.ACCOUNT.DEVICES.CONNECT", accounts: ["SERVICES"] },
      # Экспортируем команды для DEVICES (если нужно)
      { stream: "device.*.commands", accounts: ["DEVICES"] }
    ]
  },

  # ------------------------
  # Аккаунт устройств
  # ------------------------
  DEVICES: {
    users: [
      {
        user: "{{ .Values.credentials.device_user }}",
        password: "{{ .Values.credentials.device_pass }}",
        permissions: {
          subscribe: { allow: ["device.*.commands", "device.*.commands.deliver", "events.>", "_INBOX.>", "$JS.ACK.>", "$JS.HB.>" ] },
          publish:   { allow: [] }
        }
      }
    ],
    imports: [
      { stream: { account: "SYS", subject: "device.*.commands" } }
    ],
    jetstream: enabled
  },

  # ------------------------
  # Аккаунт бэкенд-сервисов
  # ------------------------
  SERVICES: {
    users: [
      {
        user: "{{ .Values.credentials.service_user }}",
        password: "{{ .Values.credentials.service_pass }}"
      }
    ],
    imports: [
      # Импортируем системный топик из SYS
      { stream: { account: "SYS", subject: "$SYS.ACCOUNT.DEVICES.CONNECT" } }
    ],
    jetstream: enabled
  }
}

# Указываем, что системный аккаунт — SYS
system_account: SYS