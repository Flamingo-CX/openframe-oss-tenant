apiVersion: apps/v1
kind: Deployment
metadata:
  name: debezium-connect
  labels:
    app: debezium-connect
spec:
  replicas: 1
  selector:
    matchLabels:
      app: debezium-connect
  template:
    metadata:
      labels:
        app: debezium-connect
    spec:
      imagePullSecrets:
        - name: docker-pat-secret

      containers:
        - name: debezium-connect
          image: quay.io/debezium/connect:3.1.1.Final
          ports:
            - containerPort: 8083
              name: connect-api
          env:
            - name: BOOTSTRAP_SERVERS
              value: "kafka-broker-headless.datasources.svc.cluster.local:9092"
            - name: CONFIG_STORAGE_TOPIC
              value: "connect-configs"
            - name: OFFSET_STORAGE_TOPIC
              value: "connect-offsets"
            - name: STATUS_STORAGE_TOPIC
              value: "connect-status"
            - name: CONNECT_PLUGIN_PATH
              value: "/kafka/connect,/jdbc-drivers"
            # Enable automatic creation of required topics (CONNECT 2.8+ feature)
            - name: CONNECT_TOPIC_CREATION_ENABLE
              value: "true"
            # Default group for any connector-requested topic
            - name: CONNECT_TOPIC_CREATION_DEFAULT_PARTITIONS
              value: "3"
            - name: CONNECT_TOPIC_CREATION_DEFAULT_REPLICATION_FACTOR
              value: "1"
            # Ensure internal config/offset/status topics are compacted
            - name: CONNECT_TOPIC_CREATION_DEFAULT_CLEANUP_POLICY
              value: "compact"
          volumeMounts:
            - name: jdbc-drivers-volume
              mountPath: /jdbc-drivers
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "1Gi"
              cpu: "500m"

      volumes:
        - name: jdbc-drivers-volume
          emptyDir: {}