apiVersion: v1
kind: ConfigMap
metadata:
  name: pinot-jmx-config
data:
  config.yml: |
    lowercaseOutputName: true
    lowercaseOutputLabelNames: true
    rules:
      # Pinot Controller metrics
      - pattern: "Pinot.Controller<type=ControllerMetrics><>([^:]+)"
        name: pinot_controller_$1
        type: GAUGE
        attrNameSnakeCase: true

      # Pinot Server metrics
      - pattern: "Pinot.Server<type=ServerMetrics><>([^:]+)"
        name: pinot_server_$1
        type: GAUGE
        attrNameSnakeCase: true

      # Query metrics
      - pattern: "Pinot<type=BrokerMetrics><>([^:]+)_([0-9]+)thPercentile"
        name: pinot_query_latency_percentile
        type: GAUGE
        labels:
          percentile: "$2"
        attrNameSnakeCase: true

      # Memory and GC metrics
      - pattern: "java.lang<type=Memory><HeapMemoryUsage>([^:]+)"
        name: jvm_memory_heap_$1
        type: GAUGE
        attrNameSnakeCase: true

      - pattern: "java.lang<type=GarbageCollector, name=([^,]+)><>CollectionCount"
        name: jvm_gc_collection_count
        type: COUNTER
        labels:
          gc: "$1"

    whitelistObjectNames:
      - "Pinot:*"
      - "java.lang:type=Memory"
      - "java.lang:type=GarbageCollector,*"
      - "java.lang:type=Threading"
