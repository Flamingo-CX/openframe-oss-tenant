# WebSocket proxy configuration for MeshCentral

# Proxy WebSocket connections to MeshCentral
location /meshrelay.ashx {
    # If no auth parameter is provided, add it with username/password
    if ($arg_auth = '') {
        # Base64 encode the username:password
        set $auth_b64 '';
        access_by_lua_block {
            local user = os.getenv("MESH_USER")
            local pass = os.getenv("MESH_PASS")
            if user and pass then
                local auth_str = user .. ":" .. pass
                ngx.var.auth_b64 = ngx.encode_base64(auth_str)
            end
        }
        
        # Rewrite the URL to include the auth parameter
        rewrite ^ $request_uri&auth=$auth_b64? last;
    }
    
    # Standard WebSocket proxy settings
    proxy_pass ${MESH_PROTOCOL}://${MESH_NGINX_HOST}:${MESH_EXTERNAL_PORT}/meshrelay.ashx;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_read_timeout 86400;  # 24 hours
    proxy_send_timeout 86400;  # 24 hours
}

# Alternative API endpoint to get WebSocket URL with auth
location /api/websocket {
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME ${MESH_DIR}/nginx-api/meshcentral-websocket.sh;
    fastcgi_param SCRIPT_NAME /api/websocket;
    fastcgi_param PATH_INFO $uri;
    fastcgi_param DOCUMENT_ROOT ${MESH_DIR}/nginx-api;
    
    # Pass environment variables
    fastcgi_param MESH_DIR ${MESH_DIR};
    fastcgi_param MESH_USER ${MESH_USER};
    fastcgi_param MESH_PASS ${MESH_PASS};
    fastcgi_param MESH_PROTOCOL ${MESH_PROTOCOL};
    fastcgi_param MESH_NGINX_HOST ${MESH_NGINX_HOST};
    fastcgi_param MESH_EXTERNAL_PORT ${MESH_EXTERNAL_PORT};
    
    fastcgi_pass unix:/var/run/fcgiwrap.socket;
}
