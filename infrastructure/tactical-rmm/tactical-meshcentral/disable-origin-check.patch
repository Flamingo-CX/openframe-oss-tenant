#!/bin/bash

# Find all JS files that might have origin checks
find /opt/tactical/node_modules/meshcentral -type f -name "*.js" -exec grep -l "origin" {} \; > /tmp/files-to-patch.txt

# For each file found, replace any origin check with a simple "return true"
while read file; do
  # Back up the original file
  cp "$file" "${file}.bak"
  
  # Replace origin checks in the file
  sed -i 's/if *(\!*origin)/if (false)/g' "$file"
  sed -i 's/req\.headers\.origin/null/g' "$file"
  
  # Log the patched file
  echo "Patched: $file"
done < /tmp/files-to-patch.txt

# Add our custom code to always allow origins
cat > /tmp/always-allow-origins.js << 'EOL'
// This is a monkey patch to disable origin checks in MeshCentral
const http = require('http');
const originalCreateServer = http.createServer;

http.createServer = function(...args) {
  const server = originalCreateServer.apply(this, args);
  
  const originalEmit = server.emit;
  server.emit = function(event, req, res) {
    if (event === 'request') {
      // Always set a valid origin header
      req.headers.origin = `http://${req.headers.host}`;
    }
    return originalEmit.apply(this, arguments);
  };
  
  return server;
};

console.log('Origin check bypass installed');
EOL

# Find and patch the server.js file which is the main entry point
SERVER_JS_FILES=$(find /opt/tactical/node_modules/meshcentral -name "server.js")
if [ -n "$SERVER_JS_FILES" ]; then
  for file in $SERVER_JS_FILES; do
    # Back up the original file
    cp "$file" "${file}.bak"
    
    # Add our code at the beginning of the file
    cat /tmp/always-allow-origins.js "$file" > /tmp/patched-file.js
    mv /tmp/patched-file.js "$file"
    
    echo "Patched server file: $file"
  done
else
  echo "Warning: Could not find server.js files"
fi

# Also patch webserver.js which handles web connections
WEB_SERVER_FILES=$(find /opt/tactical/node_modules/meshcentral -name "webserver.js")
if [ -n "$WEB_SERVER_FILES" ]; then
  for file in $WEB_SERVER_FILES; do
    # Back up the original file
    cp "$file" "${file}.bak"
    
    # Add our code at the beginning of the file
    cat /tmp/always-allow-origins.js "$file" > /tmp/patched-file.js
    mv /tmp/patched-file.js "$file"
    
    echo "Patched webserver file: $file"
  done
else
  echo "Warning: Could not find webserver.js files"
fi

echo "Origin check bypass complete" 