name: Generate Changes

on:
  workflow_call:
    inputs:
      force_all_builds:
        description: 'Force all builds'
        required: false
        default: 'false' 
        type: string
    outputs:      
      openframe-core: 
        value: ${{ jobs.changes.outputs.openframe-core }}
      openframe-data: 
        value: ${{ jobs.changes.outputs.openframe-data }}
      openframe-jwt: 
        value: ${{ jobs.changes.outputs.openframe-jwt }}
      api-library: 
        value: ${{ jobs.changes.outputs.api-library }}
      sdk-fleetmdm: 
        value: ${{ jobs.changes.outputs.sdk-fleetmdm }}
      openframe-api: 
        value: ${{ jobs.changes.outputs.openframe-api }}
      openframe-authorization-server: 
        value: ${{ jobs.changes.outputs.openframe-authorization-server }}
      openframe-external-api: 
        value: ${{ jobs.changes.outputs.openframe-external-api }}
      openframe-client: 
        value: ${{ jobs.changes.outputs.openframe-client }}
      openframe-config: 
        value: ${{ jobs.changes.outputs.openframe-config }}
      openframe-gateway: 
        value: ${{ jobs.changes.outputs.openframe-gateway }}
      openframe-management: 
        value: ${{ jobs.changes.outputs.openframe-management }}
      openframe-stream: 
        value: ${{ jobs.changes.outputs.openframe-stream }}
      openframe-ui: 
        value: ${{ jobs.changes.outputs.openframe-ui }}
      authentik-postgresql: 
        value: ${{ jobs.changes.outputs.authentik-postgresql }}
      fleetmdm: 
        value: ${{ jobs.changes.outputs.fleetmdm }}
      meshcentral: 
        value: ${{ jobs.changes.outputs.meshcentral }}
      tactical-frontend: 
        value: ${{ jobs.changes.outputs.tactical-frontend }}
      tactical-nginx: 
        value: ${{ jobs.changes.outputs.tactical-nginx }}
      tactical-base: 
        value: ${{ jobs.changes.outputs.tactical-base }}
      timestamp: 
        value: ${{ jobs.changes.outputs.timestamp }}
      timestamp_tag: 
        value: ${{ jobs.changes.outputs.timestamp_tag }}
      commit_sha: 
        value: ${{ jobs.changes.outputs.commit_sha }}

jobs:
  changes:
    name: Changes check
    runs-on: ubuntu-latest
    outputs:
      openframe-core: ${{ inputs.force_all_builds == 'true' && 'true' || steps.filter.outputs.openframe-core }}
      openframe-data: ${{ inputs.force_all_builds == 'true' && 'true' || steps.filter.outputs.openframe-data }}
      openframe-jwt: ${{ inputs.force_all_builds == 'true' && 'true' || steps.filter.outputs.openframe-jwt }}
      api-library: ${{ inputs.force_all_builds == 'true' && 'true' || steps.filter.outputs.api-library }}
      sdk-fleetmdm: ${{ inputs.force_all_builds == 'true' && 'true' || steps.filter.outputs.sdk-fleetmdm }}
      openframe-api: ${{ inputs.force_all_builds == 'true' && 'true' || steps.filter.outputs.openframe-api }}
      openframe-authorization-server: ${{ inputs.force_all_builds == 'true' && 'true' || steps.filter.outputs.openframe-authorization-server }}
      openframe-external-api: ${{ inputs.force_all_builds == 'true' && 'true' || steps.filter.outputs.openframe-external-api }}
      openframe-client: ${{ inputs.force_all_builds == 'true' && 'true' || steps.filter.outputs.openframe-client }}
      openframe-config: ${{ inputs.force_all_builds == 'true' && 'true' || steps.filter.outputs.openframe-config }}
      openframe-gateway: ${{ inputs.force_all_builds == 'true' && 'true' || steps.filter.outputs.openframe-gateway }}
      openframe-management: ${{ inputs.force_all_builds == 'true' && 'true' || steps.filter.outputs.openframe-management }}
      openframe-stream: ${{ inputs.force_all_builds == 'true' && 'true' || steps.filter.outputs.openframe-stream }}
      openframe-ui: ${{ inputs.force_all_builds == 'true' && 'true' || steps.filter.outputs.openframe-ui }}
      authentik-postgresql: ${{ inputs.force_all_builds == 'true' && 'true' || steps.filter.outputs.authentik-postgresql }}
      fleetmdm: ${{ inputs.force_all_builds == 'true' && 'true' || steps.filter.outputs.fleetmdm }}
      meshcentral: ${{ inputs.force_all_builds == 'true' && 'true' || steps.filter.outputs.meshcentral }}
      tactical-frontend: ${{ inputs.force_all_builds == 'true' && 'true' || steps.filter.outputs.tactical-frontend }}
      tactical-nginx: ${{ inputs.force_all_builds == 'true' && 'true' || steps.filter.outputs.tactical-nginx }}
      tactical-base: ${{ inputs.force_all_builds == 'true' && 'true' || steps.filter.outputs.tactical-base }}
      timestamp: ${{ steps.setup_env.outputs.timestamp }}
      timestamp_tag: ${{ steps.setup_env.outputs.timestamp_tag }}
      commit_sha: ${{ steps.setup_env.outputs.commit_sha }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up environment
        id: setup_env
        run: |
          echo "timestamp=$(date +%s)" >> $GITHUB_OUTPUT
          echo "timestamp_tag=$(date +%d%m%Y%H%M)" >> $GITHUB_OUTPUT
          echo "commit_sha=test-${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

      - uses: dorny/paths-filter@v2
        id: filter
        if: github.event_name == 'push'
        with:
          filters: |
            openframe-core:
              - './openframe/libs/openframe-core/**'
            openframe-data:
              - './openframe/libs/openframe-data/**'
              - './openframe/libs/openframe-core/**'
            openframe-jwt:
              - './openframe/libs/openframe-jwt/**'
              - './openframe/libs/openframe-core/**'
            api-library:
              - './openframe/libs/api-library/**'
              - './openframe/libs/openframe-data/**'
              - './openframe/libs/openframe-core/**'
            sdk-fleetmdm:
              - './openframe/libs/sdk-fleetmdm/**'
            openframe-api:
              - './openframe/services/openframe-api/**'
              - './openframe/libs/api-library/**'
              - './openframe/libs/openframe-data/**'
              - './openframe/libs/openframe-jwt/**'
              - './openframe/libs/openframe-core/**'
            openframe-authorization-server:
              - './openframe/services/openframe-authorization-server/**'
              - './openframe/libs/openframe-jwt/**'
              - './openframe/libs/openframe-core/**'
            openframe-external-api:
              - './openframe/services/openframe-external-api/**'
              - './openframe/libs/api-library/**'
              - './openframe/libs/openframe-data/**'
              - './openframe/libs/openframe-core/**'
            openframe-client:
              - './openframe/services/openframe-client/**'
              - './openframe/libs/openframe-data/**'
              - './openframe/libs/openframe-jwt/**'
              - './openframe/libs/openframe-core/**'
            openframe-config:
              - './openframe/services/openframe-config/**'
            openframe-gateway:
              - './openframe/services/openframe-gateway/**'
              - './openframe/libs/openframe-jwt/**'
              - './openframe/libs/openframe-data/**'
              - './openframe/libs/openframe-core/**'
            openframe-management:
              - './openframe/services/openframe-management/**'
              - './openframe/libs/openframe-core/**'
              - './openframe/libs/openframe-data/**'
            openframe-stream:
              - './openframe/services/openframe-stream/**'
              - './openframe/libs/sdk-fleetmdm/**'
              - './openframe/libs/openframe-core/**'
              - './openframe/libs/openframe-data/**'
            openframe-ui:
              - './openframe/services/openframe-ui/**'
            authentik-postgresql:
              - './integrated-tools/authentik/postgresql/**'
            fleetmdm:
              - './integrated-tools/fleetmdm/**'
            meshcentral:
              - './integrated-tools/meshcentral/server/**'
            tactical-frontend:
              - './integrated-tools/tactical-rmm/tactical-frontend/**'
              - './integrated-tools/tactical-rmm/shared/**'
            tactical-nginx:
              - './integrated-tools/tactical-rmm/tactical-nginx/**'
              - './integrated-tools/tactical-rmm/shared/**'
            tactical-base:
              - './integrated-tools/tactical-rmm/tactical-base/**'
              - './integrated-tools/tactical-rmm/shared/**'
