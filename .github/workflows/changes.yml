name: Generate Changes

on:
  workflow_call:
    outputs:      
      openframe-core: 
        value: ${{ jobs.changes.outputs.openframe-core }}
      openframe-data: 
        value: ${{ jobs.changes.outputs.openframe-data }}
      openframe-jwt: 
        value: ${{ jobs.changes.outputs.openframe-jwt }}
      openframe-api: 
        value: ${{ jobs.changes.outputs.openframe-api }}
      external-api: 
        value: ${{ jobs.changes.outputs.external-api }}
      openframe-client: 
        value: ${{ jobs.changes.outputs.openframe-client }}
      openframe-config: 
        value: ${{ jobs.changes.outputs.openframe-config }}
      openframe-gateway: 
        value: ${{ jobs.changes.outputs.openframe-gateway }}
      openframe-management: 
        value: ${{ jobs.changes.outputs.openframe-management }}
      openframe-stream: 
        value: ${{ jobs.changes.outputs.openframe-stream }}
      mongodb: 
        value: ${{ jobs.changes.outputs.mongodb }}
      cassandra: 
        value: ${{ jobs.changes.outputs.cassandra }}
      authentik-postgresql: 
        value: ${{ jobs.changes.outputs.authentik-postgresql }}
      tactical-nginx: 
        value: ${{ jobs.changes.outputs.tactical-nginx }}
      tactical-backend: 
        value: ${{ jobs.changes.outputs.tactical-backend }}
      tactical-nats: 
        value: ${{ jobs.changes.outputs.tactical-nats }}
      tactical-websockets: 
        value: ${{ jobs.changes.outputs.tactical-websockets }}
      tactical-celery: 
        value: ${{ jobs.changes.outputs.tactical-celery }}
      tactical-celerybeat: 
        value: ${{ jobs.changes.outputs.tactical-celerybeat }}
      fleetmdm: 
        value: ${{ jobs.changes.outputs.fleetmdm }}
      meshcentral: 
        value: ${{ jobs.changes.outputs.meshcentral }}
      timestamp: 
        value: ${{ jobs.changes.outputs.timestamp }}
      timestamp_tag: 
        value: ${{ jobs.changes.outputs.timestamp_tag }}
      commit_sha: 
        value: ${{ jobs.changes.outputs.commit_sha }}

jobs:
  changes:
    name: Changes check
    runs-on: ubuntu-latest
    outputs:
      openframe-core: ${{ steps.filter.outputs.openframe-core }}
      openframe-data: ${{ steps.filter.outputs.openframe-data }}
      openframe-jwt: ${{ steps.filter.outputs.openframe-jwt }}
      openframe-api: ${{ steps.filter.outputs.openframe-api }}
      external-api: ${{ steps.filter.outputs.external-api }}
      openframe-client: ${{ steps.filter.outputs.openframe-client }}
      openframe-config: ${{ steps.filter.outputs.openframe-config }}
      openframe-gateway: ${{ steps.filter.outputs.openframe-gateway }}
      openframe-management: ${{ steps.filter.outputs.openframe-management }}
      openframe-stream: ${{ steps.filter.outputs.openframe-stream }}
      mongodb: ${{ steps.filter.outputs.mongodb }}
      cassandra: ${{ steps.filter.outputs.cassandra }}
      authentik-postgresql: ${{ steps.filter.outputs.authentik-postgresql }}
      tactical-nginx: ${{ steps.filter.outputs.tactical-nginx }}
      tactical-backend: ${{ steps.filter.outputs.tactical-backend }}
      tactical-nats: ${{ steps.filter.outputs.tactical-nats }}
      tactical-websockets: ${{ steps.filter.outputs.tactical-websockets }}
      tactical-celery: ${{ steps.filter.outputs.tactical-celery }}
      tactical-celerybeat: ${{ steps.filter.outputs.tactical-celerybeat }}
      fleetmdm: ${{ steps.filter.outputs.fleetmdm }}
      meshcentral: ${{ steps.filter.outputs.meshcentral }}
      timestamp: ${{ steps.setup_env.outputs.timestamp }}
      timestamp_tag: ${{ steps.setup_env.outputs.timestamp_tag }}
      commit_sha: ${{ steps.setup_env.outputs.commit_sha }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up environment
        id: setup_env
        run: |
          echo "timestamp=$(date +%s)" >> $GITHUB_OUTPUT
          echo "timestamp_tag=$(date +%d%m%Y%H%M)" >> $GITHUB_OUTPUT
          echo "commit_sha=test-${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            openframe-core:
              - './openframe/libs/openframe-core/**'
            openframe-data:
              - './openframe/libs/openframe-data/**'
            openframe-jwt:
              - './openframe/libs/openframe-jwt/**'
            openframe-api:
              - './openframe/services/openframe-api/**'
            external-api:
              - './openframe/services/external-api/**'
            openframe-client:
              - './openframe/services/openframe-client/**'
            openframe-config:
              - './openframe/services/openframe-config/**'
            openframe-gateway:
              - './openframe/services/openframe-gateway/**'
            openframe-management:
              - './openframe/services/openframe-management/**'
            openframe-stream:
              - './openframe/services/openframe-stream/**'
            authentik-postgresql:
              - './integrated-tools/authentik/postgresql/**'
            tactical-nginx:
              - './integrated-tools/tactical-rmm/tactical-nginx/**'
              - './integrated-tools/tactical-rmm/shared/**'
            tactical-backend:
              - './integrated-tools/tactical-rmm/tactical-base/**'
              - './integrated-tools/tactical-rmm/shared/**'
            tactical-nats:
              - './integrated-tools/tactical-rmm/tactical-base/**'
              - './integrated-tools/tactical-rmm/shared/**'
            tactical-websockets:
              - './integrated-tools/tactical-rmm/tactical-base/**'
              - './integrated-tools/tactical-rmm/shared/**'
            tactical-celery:
              - './integrated-tools/tactical-rmm/tactical-base/**'
              - './integrated-tools/tactical-rmm/shared/**'
            tactical-celerybeat:
              - './integrated-tools/tactical-rmm/tactical-base/**'
              - './integrated-tools/tactical-rmm/shared/**'
            fleetmdm:
              - './integrated-tools/fleetmdm/**'
            meshcentral:
              - './integrated-tools/meshcentral/server/**'
