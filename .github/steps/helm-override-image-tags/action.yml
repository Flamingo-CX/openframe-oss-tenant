name: 'Override Helm Values'
description: 'Override Helm values with image tags for changed services'

inputs:
  commit-sha:
    description: 'Commit SHA for the image tag'
    required: true
  matrix:
    description: 'Matrix configuration'
    required: true
  changes:
    description: 'Changes output'
    required: true
  helm-values-file:
    description: 'Path to helm-values.yaml file'
    required: false
    default: 'scripts/helm-values.yaml'

runs:
  using: 'composite'
  steps:
    - name: Override Helm values
      shell: bash
      env:
        COMMIT_SHA: "${{ inputs.commit-sha }}"
        MATRIX: '${{ inputs.matrix }}'
        CHANGES: '${{ inputs.changes }}'
        HELM_VALUES_FILE: '${{ inputs.helm-values-file }}'
      run: |
        set -euo pipefail
        
        # Validate required inputs
        [ -n "$COMMIT_SHA" ] || { echo "Error: COMMIT_SHA is required" >&2; exit 1; }
        [ -n "$MATRIX" ] || { echo "Error: MATRIX is required" >&2; exit 1; }
        [ -n "$CHANGES" ] || { echo "Error: CHANGES is required" >&2; exit 1; }
        [ -f "$HELM_VALUES_FILE" ] && { echo "Error: File already exists: $HELM_VALUES_FILE" >&2; exit 1; }

        # Install yq if needed
        if ! command -v yq &> /dev/null; then
          wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq
        fi
        
        # Function to set image tags
        set_image_tag() {
          local path="$1"
          if yq eval ".apps.$path = \"$COMMIT_SHA\"" -i "$HELM_VALUES_FILE" 2>/dev/null; then
            echo "Updated $path with image tag: $COMMIT_SHA"
          else
            echo "Failed to update $path" >&2
          fi
        }

        # Create a new empty file
        touch "$HELM_VALUES_FILE"
        echo "reated new file: $HELM_VALUES_FILE"

        echo "Updating Helm values with tag: $COMMIT_SHA"
        # Process each changed service
        jq -c '.[]' <<< "$MATRIX" | while read -r item; do
          name=$(jq -r '.name' <<< "$item")
          changed=$(jq -r --arg name "$name" '.[$name]' <<< "$CHANGES")

          [ "$changed" = "true" ] || continue
          
          # Add image tag to the app's helm values
          case "$name" in
            tactical-*)
              component="${name#tactical-}"
              set_image_tag "tactical-rmm.values.tactical.$component.image.tag"
              ;;
            authentik-postgresql)
              set_image_tag "authentik.values.postgres.image.tag"
              ;;
            fleetmdm | meshcentral)
              set_image_tag "$name.values.server.image.tag"
              ;;
            *)
              set_image_tag "$name.values.image.tag"
              ;;
          esac

        done
