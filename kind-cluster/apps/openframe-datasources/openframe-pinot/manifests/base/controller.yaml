---
apiVersion: v1
kind: ConfigMap
metadata:
  name: openframe-pinot-controller-config
data:
  controller.conf: |
    controller.host=pinot-controller
    controller.port=9000
    controller.data.dir=/opt/pinot/data/controller
    controller.broker.protocol=http
    controller.query.console.enabled=true
    controller.admin.access.control.enabled=false
    controller.helix.instance.id=Controller_pinot-controller_9000
    controller.enable.split.commit=true
    controller.local.temp.dir=/tmp/pinot-tmp-data/controller
    controller.task.scheduler.enabled=false
    pinot.set.instance.id.to.hostname=false
    controller.zk.str=zookeeper.openframe-datasources:2181
    controller.helix.cluster.name=openframe-pinot
---
# Controller Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: openframe-pinot-controller
spec:
  replicas: 1
  selector:
    matchLabels:
      app: openframe-pinot
      component: controller
  template:
    metadata:
      labels:
        app: openframe-pinot
        component: controller
    spec:
      initContainers:
      - name: init-jmx
        image: busybox
        command:
          - "sh"
          - "-c"
          - "wget -O /opt/jmx_exporter/jmx_prometheus_javaagent.jar https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/1.0.1/jmx_prometheus_javaagent-1.0.1.jar"
        volumeMounts:
        - name: jmx-exporter
          mountPath: /opt/jmx_exporter
      containers:
      - name: pinot-controller
        image: apachepinot/pinot:latest
        args:
          - "StartController"
          - "-configFileName"
          - "/opt/pinot/conf/controller.conf"
        ports:
        - containerPort: 9000
          name: controller
        - containerPort: 9011
          name: jmx
        env:
        - name: JAVA_OPTS
          value: "-javaagent:/opt/jmx_exporter/jmx_prometheus_javaagent.jar=9011:/opt/jmx_exporter/config.yml"
        volumeMounts:
        - name: jmx-exporter
          mountPath: /opt/jmx_exporter
        - name: jmx-config
          mountPath: /opt/jmx_exporter/config.yml
          subPath: config.yml
        - name: pinot-config
          mountPath: /opt/pinot/conf/controller.conf
          subPath: controller.conf
        - name: controller-data
          mountPath: /opt/pinot/data
      volumes:
      - name: jmx-exporter
        emptyDir: {}
      - name: jmx-config
        configMap:
          name: openframe-pinot-jmx-config
      - name: pinot-config
        configMap:
          name: openframe-pinot-controller-config
      - name: controller-data
        emptyDir: {}
---
# Services
apiVersion: v1
kind: Service
metadata:
  name: openframe-pinot-controller
  labels:
    app: openframe-pinot
    component: controller
spec:
  selector:
    app: openframe-pinot
    component: controller
  ports:
    - port: 9000
      name: controller
    - port: 9011
      name: jmx
  type: ClusterIP