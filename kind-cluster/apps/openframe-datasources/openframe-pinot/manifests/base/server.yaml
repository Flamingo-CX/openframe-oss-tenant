---
apiVersion: v1
kind: ConfigMap
metadata:
  name: openframe-pinot-server-config
data:
  server.conf: |
    pinot.server.netty.port=8098
    pinot.server.instance.dataDir=/opt/pinot/data/server
    pinot.server.instance.segmentTarDir=/opt/pinot/data/server/segments
    pinot.server.starter.type=helix
    pinot.server.helix.instance.id=Server_pinot-server_8098
    pinot.server.adminapi.port=8097
    pinot.server.netty.host=0.0.0.0
    pinot.server.starter.enableSegmentBuildTimeLogging=false
    pinot.server.instance.enable.shutdown.delay=true
    pinot.server.helix.flappingTimeWindowMs=10000
    pinot.server.helix.enabled=true
    # pinot.server.helix.zk.str=zookeeper.openframe-datasources:2181
    # pinot.server.helix.cluster.name=openframe-pinot
    pinot.set.instance.id.to.hostname=false
---
# Server Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: openframe-pinot-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: openframe-pinot
      component: server
  template:
    metadata:
      labels:
        app: openframe-pinot
        component: server
    spec:
      initContainers:
      - name: wait-for-zookeeper
        image: busybox
        command:
          - "sh"
          - "-c"
          - "until nc -z zookeeper 2181; do sleep 1; done"
      - name: wait-for-controller
        image: busybox
        command: ['sh', '-c', 'until nc -z openframe-pinot-controller 9000; do echo waiting for controller; sleep 3; done']
      - name: wait-for-broker
        image: busybox
        command: ['sh', '-c', 'until nc -z openframe-pinot-broker 8099; do echo waiting for broker; sleep 3; done']
      - name: init-jmx
        image: busybox
        command:
          - "sh"
          - "-c"
          - "wget -O /opt/jmx_exporter/jmx_prometheus_javaagent.jar https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/1.0.1/jmx_prometheus_javaagent-1.0.1.jar"
        volumeMounts:
        - name: jmx-exporter
          mountPath: /opt/jmx_exporter
      containers:
      - name: pinot-server
        image: apachepinot/pinot:latest
        args:
          - "StartServer"
          - -clusterName
          - openframe-pinot
          - -zkAddress
          - zookeeper:2181
          - "-configFileName"
          - "/opt/pinot/conf/server.conf"
        ports:
        - containerPort: 8098
          name: server
        - containerPort: 9011
          name: jmx
        env:
        - name: JAVA_OPTS
          value: "-javaagent:/opt/jmx_exporter/jmx_prometheus_javaagent.jar=9011:/opt/jmx_exporter/config.yml"
        volumeMounts:
        - name: jmx-exporter
          mountPath: /opt/jmx_exporter
        - name: jmx-config
          mountPath: /opt/jmx_exporter/config.yml
          subPath: config.yml
        - name: pinot-config
          mountPath: /opt/pinot/conf/server.conf
          subPath: server.conf
        - name: server-data
          mountPath: /opt/pinot/data
      volumes:
      - name: jmx-exporter
        emptyDir: {}
      - name: jmx-config
        configMap:
          name: openframe-pinot-jmx-config
      - name: pinot-config
        configMap:
          name: openframe-pinot-server-config
      - name: server-data
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: openframe-pinot-server
  labels:
    app: openframe-pinot
    component: server
spec:
  selector:
    app: openframe-pinot
    component: server
  ports:
    - port: 8098
      name: server
    - port: 9011
      name: jmx
  type: ClusterIP
